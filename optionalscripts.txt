use pm2 to manage nodejs with

pm2 --name prox start npm -- start

pm2 restart example


nohup ./prox_sync.sh > ~/nohup_sync_reload.log 2>&1 &

prox_sync.sh contents

#!/bin/bash

# Define the log file path
LOG_FILE="/home/prx/prx/fpp/nextrestart.log"

while true; do
  # --- Read and Validate Schedule ---
  if ! NEXT_MS=$(cat "$LOG_FILE" 2>/dev/null); then
    echo "Error: Could not read $LOG_FILE. Retrying in 60 seconds." >&2
    sleep 60
    continue
  fi

  if ! [[ "$NEXT_MS" =~ ^[0-9]+$ ]]; then
     echo "Error: Content of $LOG_FILE is not a valid number ('$NEXT_MS'). Retrying in 60 seconds." >&2
     sleep 60
     continue
  fi

  # --- Calculate Sleep Time ---
  NEXT_SEC=$(( NEXT_MS / 1000 ))
  NOW_SEC=$(date +%s)
  SLEEP_SEC=$(( NEXT_SEC - NOW_SEC ))

  # Handle cases where the scheduled time is in the past
  if [ $SLEEP_SEC -lt 0 ]; then
    echo "Warning: Scheduled time (epoch $NEXT_SEC) is in the past. Running immediately." >&2
    SLEEP_SEC=0
  fi

  # --- Sleep Until Scheduled Time ---
  echo "Current time: $(date). Next run scheduled around epoch: $NEXT_SEC. Sleeping for $SLEEP_SEC seconds."
  sleep $SLEEP_SEC

  # --- Execute Control D Reload ---
  echo "Preparing to run Control D reload..."

  # Execute the Control D reload command
  echo "Executing 'sudo ctrld reload'..."
  COMMAND_OUTPUT=$(sudo ctrld reload 2>&1) # Capture stdout and stderr
  COMMAND_EXIT_STATUS=$? # Capture the exit status

  # Report command status
  if [ $COMMAND_EXIT_STATUS -ne 0 ]; then
    echo "Warning: The 'ctrld reload' command finished with a non-zero exit status ($COMMAND_EXIT_STATUS)." >&2
    echo "Command Output: $COMMAND_OUTPUT" >&2
  else
    echo "'ctrld reload' command completed successfully."
    # Optionally log output even on success if needed
    # echo "Command Output: $COMMAND_OUTPUT"
  fi

  # --- Post-Execution Delay ---
  # Add a small delay if the run was immediate to prevent tight loops on errors
  if [ $SLEEP_SEC -eq 0 ]; then
      echo "Adding a small delay (5s) after immediate run..."
      sleep 5
  fi

done
